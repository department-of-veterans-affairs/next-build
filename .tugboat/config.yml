services:
  nextjs:
    image: tugboatqa/node:18.17.0
    # Explicitly set this as the default service
    #   1. Clones the git repository into the service container
    #   2. Exposes port 80 to the Tugboat HTTP proxy
    #   3. Routes requests to the preview URL to this service
    default: true
    # Run these commands to initialize the server, update it with any libraries and assets required, then build your site.
    commands:
      # Commands that set up the basic preview infrastructure

      # Changes made in this section will _not_ automatically take effect when
      # base previews are refreshed through the scheduled process! A manual
      # rebuild of the base preview is necessary.
      init:
        # Install Node.js from the new repository
        - curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && sudo apt-get install -y nodejs

        # Install and use our yarn version
        - corepack enable
        - corepack prepare yarn@3.6.1 --activate

        # Install VA Root CA
        - cp "${TUGBOAT_ROOT}"/certs/*.crt /usr/local/share/ca-certificates
        - update-ca-certificates

        # Tugboat user can run our scripts
        - chmod -R 775 "./scripts/"

      # Commands that import files, databases,  or other assets. When an
      # existing preview is refreshed, the build workflow starts here,
      # skipping the init step, because the results of that step will
      # already be present.
      update:
        # Clone vets-website
        - ./scripts/install-repos.sh

        - yarn --version
        # Install dependencies. These are included in .yarn/cache, shouldn't add significant time or network requests.
        - yarn install

        # Get vets-website assets in the right place
        - BUILD_TYPE=tugboat node ./scripts/yarn/vets-website-assets.js

      online:
        # Build the static pages. Set for self-signed certs
        - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt yarn build:preview

        # Build the static pages. Set for self-signed certs
        - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt yarn start
