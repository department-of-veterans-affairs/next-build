services:
  # Configure a standard apache webserver to host our site.
  web:
    # Use the most recent version of nginx.
    image: tugboatqa/nginx:latest

    # Explicitly set this as the default service
    #   1. Clones the git repository into the service container
    #   2. Exposes port 80 to the Tugboat HTTP proxy
    #   3. Routes requests to the preview URL to this service
    default: true

    # Run these commands to initialize the server, update it with any libraries and assets required, then build your site.
    commands:
      # Commands that set up the basic preview infrastructure

      # Changes made in this section will _not_ automatically take effect when
      # base previews are refreshed through the scheduled process! A manual
      # rebuild of the base preview is necessary.
      init:
        # Create a directory for the new repository's keyring, if it doesn't exist
        - mkdir -p /etc/apt/keyrings
        # Download the new repository's GPG key and save it in the keyring directory
        - curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
        # Add the new repository's source list with its GPG key for package verification
        - echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_18.x nodistro main" | sudo tee /etc/apt/sources.list.d/nodesource.list
        # Update local package index to recognize the new repository
        - sudo apt-get update

        # Install Cypress dependencies - https://docs.cypress.io/guides/getting-started/installing-cypress.html#System-requirements
        - apt-get install libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb

        # .tugboat/.env.j2 Jinja2 template file support
        - apt-get install python3-apt python3-distutils python3
        - curl -O https://bootstrap.pypa.io/get-pip.py
        # Remove externally managed script causing error in bookworm when python3 tries to install packages
        - rm /usr/lib/python3.11/EXTERNALLY-MANAGED
        - python3 get-pip.py
        - echo "export PATH=/var/lib/tugboat/bin:~/.local/bin:$PATH" >> ~/.bashrc
        - pip3 install j2cli

        # Install Node.js from the new repository
        - sudo apt-get install -y nodejs

        # Install yarn
        - corepack enable
        - corepack prepare yarn@stable --activate

        # Install VA Root CA
        - cp "${TUGBOAT_ROOT}"/certs/*.crt /usr/local/share/ca-certificates
        - update-ca-certificates

        # Install github-status-updater
        - chmod -R 775 "./scripts/"
        - ./scripts/install_github_status_updater.sh

      # Load dependent libraries and assets to prepare the site for build.
      update:
        - yarn --version
        # install dependencies
        - yarn install

      # Run any commands needed to build the site.
      build:
        # Get additional env vars in place
        - j2 "${TUGBOAT_ROOT}/.tugboat/.env.j2" -o "${TUGBOAT_ROOT}/.env"

        # Set cypress tests as pending
        - github-status-updater -action=update_state -state="pending" -context="test:cypress" -description="Waiting for static site generation..."

        # Build the static pages. Set for self-signed certs
        - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt yarn export
        # Generate sitemap
        - SITE_URL=${TUGBOAT_DEFAULT_SERVICE_URL} yarn postbuild
        # Set the webroot to the output folder.
        - ln -snf "${TUGBOAT_ROOT}/out" "${DOCROOT}"

      # Run any commands after the site is built.
      online:
        # Update cypress test status message
        - github-status-updater -action=update_state -state="pending" -context="test:cypress" -description="Site built, running Cypress tests..."

        # Run cypress tests.
        - yarn test:cypress

        # Set cypress tests as completed. Add pass/fail handling once tests are working properly.
        - github-status-updater -action=update_state -state="Success" -context="test:cypress" -description="Cypress tests completed"
